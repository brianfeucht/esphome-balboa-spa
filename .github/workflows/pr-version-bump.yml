name: Auto-bump VERSION on PR

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump VERSION if not updated
    runs-on: ubuntu-latest
    # Skip for forks - cannot push commits to a fork branch from this repo
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update VERSION and version.h
        run: |
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:VERSION 2>/dev/null | tr -d '[:space:]' || echo "")
          CURRENT_VERSION=$(cat VERSION 2>/dev/null | tr -d '[:space:]' || echo "")

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            # VERSION not changed in this PR - auto-bump minor (X.Y -> X.Y+1)
            if [ -z "$BASE_VERSION" ]; then
              NEW_VERSION="1.0"
            else
              MAJOR="${BASE_VERSION%%.*}"
              MINOR="${BASE_VERSION##*.}"
              NEW_VERSION="${MAJOR}.$((MINOR + 1))"
            fi
            echo "$NEW_VERSION" > VERSION
            echo "Auto-bumped VERSION: $BASE_VERSION -> $NEW_VERSION"
          else
            NEW_VERSION="$CURRENT_VERSION"
            echo "Using PR-provided VERSION: $NEW_VERSION"
          fi

          # Regenerate version.h to match VERSION
          python3 - <<'EOF'
          import sys
          version = open('VERSION').read().strip()
          content = (
              '#pragma once\n'
              '// Auto-generated by CI/CD pipeline - do not edit manually.\n'
              '// To change the version, update the VERSION file at the repo root.\n'
              f'#define BALBOA_SPA_VERSION "v{version}"\n'
          )
          open('components/balboa_spa/version.h', 'w').write(content)
          print(f'Generated version.h: BALBOA_SPA_VERSION = v{version}')
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION components/balboa_spa/version.h
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update VERSION to $(cat VERSION) [skip ci]"
            git push origin HEAD:${{ github.head_ref }}
          fi
